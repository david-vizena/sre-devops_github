apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: portfolio-slos
  namespace: monitoring
  labels:
    role: slo
spec:
  groups:
    - name: portfolio-availability
      rules:
        - record: slo:http_requests_total:rate5m
          expr: sum(rate(http_requests_total[5m]))
        - record: slo:http_requests_error_total:rate5m
          expr: sum(rate(http_requests_total{status=~"5.."}[5m]))
        - record: slo:http_availability:ratio5m
          expr: 1 - (slo:http_requests_error_total:rate5m / clamp_min(slo:http_requests_total:rate5m, 1))
        - alert: ServiceAvailabilityBelowSLO
          expr: slo:http_availability:ratio5m < 0.999
          for: 15m
          labels:
            severity: warning
            slo: availability
          annotations:
            summary: "Availability SLO burn detected"
            description: "HTTP availability over the last 15 minutes fell below the 99.9% target."
    - name: portfolio-latency
      rules:
        - record: slo:http_latency_p95:5m
          expr: histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket[5m])))
        - alert: HighLatencyP95
          expr: slo:http_latency_p95:5m > 0.5
          for: 10m
          labels:
            severity: warning
            slo: latency
          annotations:
            summary: "p95 latency above target"
            description: "The 95th percentile latency is above 500ms for 10 minutes."
    - name: portfolio-error-burn
      rules:
        - alert: FastErrorBudgetBurn
          expr: >
            (sum(rate(http_requests_total{status=~"5.."}[5m])) /
             clamp_min(sum(rate(http_requests_total[5m])), 1)) > (1 - 0.999) * 4
          for: 5m
          labels:
            severity: critical
            slo: error-budget
            burn_window: 5m
          annotations:
            summary: "Fast error budget burn"
            description: "Error budget burn rate is greater than 4x the allowance over the past 5 minutes."
        - alert: SlowErrorBudgetBurn
          expr: >
            (sum(rate(http_requests_total{status=~"5.."}[1h])) /
             clamp_min(sum(rate(http_requests_total[1h])), 1)) > (1 - 0.999) * 2
          for: 1h
          labels:
            severity: warning
            slo: error-budget
            burn_window: 1h
          annotations:
            summary: "Slow error budget burn"
            description: "Sustained error budget burn greater than 2x the allowance over the past hour."

