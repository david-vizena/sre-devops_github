apiVersion: apps/v1
kind: Deployment
metadata:
  name: python-service-worker
  namespace: default
  labels:
    app: python-service-worker
    component: analytics-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: python-service-worker
  template:
    metadata:
      labels:
        app: python-service-worker
        component: analytics-worker
    spec:
      imagePullSecrets:
        - name: acr-secret
      containers:
        - name: python-service-worker
          image: acrsredevops.azurecr.io/python-service:latest
          imagePullPolicy: Always
          command: ["python", "worker.py"]
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: RABBITMQ_HOST
              value: "rabbitmq-rabbitmq.data-services.svc.cluster.local"
            - name: RABBITMQ_PORT
              value: "5672"
            - name: RABBITMQ_QUEUE
              value: "analytics.events"
            - name: RABBITMQ_PREFETCH
              value: "5"
            - name: RABBITMQ_USERNAME
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-rabbitmq
                  key: rabbitmq-username
            - name: RABBITMQ_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-rabbitmq
                  key: rabbitmq-password
            - name: POSTGRES_HOST
              value: "postgresql-postgresql.data-services.svc.cluster.local"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgresql-postgresql
                  key: app-database
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgresql-postgresql
                  key: app-username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-postgresql
                  key: app-password
            - name: POSTGRES_SSLMODE
              value: "disable"
            - name: MONGODB_HOST
              value: "mongodb-mongodb.data-services.svc.cluster.local"
            - name: MONGODB_PORT
              value: "27017"
            - name: MONGODB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-mongodb
                  key: mongodb-root-username
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-mongodb
                  key: mongodb-root-password
            - name: MONGODB_AUTH_SOURCE
              value: "admin"
            - name: MONGODB_DATABASE
              value: "analytics"
            - name: MONGODB_COLLECTION
              value: "transactions_summary"
            - name: MINIO_ENDPOINT
              value: "minio-minio.data-services.svc.cluster.local:9000"
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-minio
                  key: accesskey
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-minio
                  key: secretkey
            - name: MINIO_BUCKET
              value: "analytics-reports"
            - name: MINIO_SECURE
              value: "false"
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "250m"
              memory: "256Mi"

